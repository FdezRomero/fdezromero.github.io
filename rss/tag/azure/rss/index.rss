<!DOCTYPE html>
<html><rss xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:media="http://search.yahoo.com/mrss/" version="2.0"><channel><title>Azure - Rodrigo Fernández</title><description>Full-stack Javascript, Ionic and Startups</description><link>http://fdezromero.com/</link><image><url>http://fdezromero.com/favicon.png</url><title>Azure - Rodrigo Fernández</title><link>http://fdezromero.com/</link></image><generator>Ghost 2.6</generator><lastBuildDate>Sun, 18 Nov 2018 18:35:44 GMT</lastBuildDate><atom:link href="http://fdezromero.com/tag/azure/rss/" rel="self" type="application/rss+xml"/><ttl>60</ttl><item><title>How To Connect Virtual Networks through a VPN in the New Azure Portal (Resource Manager)</title><description>This article covers a very common use case for startups using Microsoft Azure and BizSpark: how to connect virtual machines from two virtual networks in different subscriptions (or regions) with the new Azure Portal (Resource Manager or ARM).</description><link>http://fdezromero.com/how-to-connect-virtual-networks-through-a-vpn-in-the-new-azure-portal-resource-manager/</link><guid isPermaLink="false">5bf18c97ae310cb196c77217</guid><category>Azure</category><dc:creator>Rodrigo Fernández</dc:creator><pubDate>Sat, 01 Apr 2017 10:00:00 GMT</pubDate><media:content url="http://fdezromero.com/content/images/2018/11/1_KXZKF9RkS1Tdr0yYFGcY6Q.jpg" medium="image"/><content:encoded>&lt;img src="http://fdezromero.com/content/images/2018/11/1_KXZKF9RkS1Tdr0yYFGcY6Q.jpg" alt="How To Connect Virtual Networks through a VPN in the New Azure Portal (Resource Manager)"&gt;&lt;p&gt;This article covers a very common use case for startups using Microsoft Azure and BizSpark: how to connect virtual machines from two virtual networks in different subscriptions (or regions) with the new Azure Portal (Resource Manager or ARM).&lt;/p&gt;&lt;p&gt;The BizSpark program gives startups like &lt;a href="https://savelist.co/?utm_source=engineering_blog" rel="noopener"&gt;Savelist&lt;/a&gt; free Azure credits for up to 3 years. The catch is that these credits are divided in several subscriptions with $150/€130 each (one per team member). In order to get the most out of the BizSpark credits, you’ll want to use more than one subscription, but all the resources you create are bound to that subscription. The &lt;em&gt;easiest&lt;/em&gt; (note I didn’t write &lt;em&gt;easy&lt;/em&gt;) way is to connect the virtual networks through a VPN at the infrastructure level, using what Azure calls &lt;strong&gt;&lt;strong&gt;Virtual Network Gateways&lt;/strong&gt;&lt;/strong&gt;.&lt;/p&gt;&lt;h4 id="so-to-be-clear-this-article-supposes-that-"&gt;So to be clear, this article supposes that:&lt;/h4&gt;&lt;ul&gt;&lt;li&gt;Your VMs and virtual networks were created in the &lt;strong&gt;&lt;strong&gt;new Azure Portal&lt;/strong&gt;&lt;/strong&gt;(&lt;strong&gt;&lt;strong&gt;Resource Manager&lt;/strong&gt;&lt;/strong&gt; mode or ARM), not the old Classic Portal (Service Manager mode or ASM) .&lt;/li&gt;&lt;li&gt;These VMs are in &lt;strong&gt;&lt;strong&gt;different virtual networks&lt;/strong&gt;&lt;/strong&gt;. It doesn’t matter if they are in the same subscription, in other subscription or in another Azure location. We’ll connect them with a secure VPN that will route the traffic over the Internet (but inside the Azure backbone). If they are in the same virtual network, the VMs will just see each other and you don’t need any of this.&lt;/li&gt;&lt;li&gt;You want to use the &lt;strong&gt;&lt;strong&gt;Azure Portal&lt;/strong&gt;&lt;/strong&gt; instead of the Azure CLI or PowerShell. Because we are cool dev hipsters, not SysAdmins from the 90s (although the Azure CLI is wrote in NodeJS and that’s also cool).&lt;/li&gt;&lt;/ul&gt;&lt;hr&gt;&lt;h4 id="requirements"&gt;Requirements&lt;/h4&gt;&lt;p&gt;Before we can connect the virtual networks, there are some requirements and considerations:&lt;/p&gt;&lt;ul&gt;&lt;li&gt;The &lt;strong&gt;&lt;strong&gt;address spaces&lt;/strong&gt;&lt;/strong&gt; of the virtual networks &lt;strong&gt;&lt;strong&gt;cannot collide&lt;/strong&gt;&lt;/strong&gt;. If they did, when a VM wanted to connect to a local IP, the virtual network wouldn’t know how to route this request.&lt;/li&gt;&lt;li&gt;We will need to &lt;strong&gt;&lt;strong&gt;create two Virtual Network Gateways&lt;/strong&gt;&lt;/strong&gt;, one for each network. These cost around $27/€23 a piece (in March 2016).&lt;/li&gt;&lt;li&gt;You may also have to pay for &lt;strong&gt;&lt;strong&gt;outbound data traffic sent between the networks&lt;/strong&gt;&lt;/strong&gt; if they are in different regions or outside of Azure, as the VPN connection will be established using public IPs, and therefore routed through the Internet. You won’t be charged twice, as inbound traffic is always free.&lt;/li&gt;&lt;/ul&gt;&lt;h4 id="deployment-overview"&gt;Deployment Overview&lt;/h4&gt;&lt;p&gt;These are all the resources we will use. I’ll be using the letters &lt;strong&gt;&lt;strong&gt;a&lt;/strong&gt;&lt;/strong&gt; and &lt;strong&gt;&lt;strong&gt;b&lt;/strong&gt;&lt;/strong&gt; to refer to each side of the connection. You can name them whatever you want but I recommend writing your equivalent in a cheat sheet:&lt;/p&gt;&lt;ul&gt;&lt;li&gt;2 existing Virtual Networks: &lt;strong&gt;&lt;strong&gt;network-a&lt;/strong&gt;&lt;/strong&gt; and &lt;strong&gt;&lt;strong&gt;network-b&lt;/strong&gt;&lt;/strong&gt;.&lt;/li&gt;&lt;li&gt;2 or more existing Subnets: &lt;strong&gt;&lt;strong&gt;subnet-a&lt;/strong&gt;&lt;/strong&gt; and &lt;strong&gt;&lt;strong&gt;subnet-b&lt;/strong&gt;&lt;/strong&gt;, inside &lt;em&gt;network-a&lt;/em&gt; and &lt;em&gt;network-b&lt;/em&gt;, respectively.&lt;/li&gt;&lt;li&gt;2 new Virtual Network Gateways: &lt;strong&gt;&lt;strong&gt;vpn-gateway-a&lt;/strong&gt;&lt;/strong&gt; and &lt;strong&gt;&lt;strong&gt;vpn-gateway-b&lt;/strong&gt;&lt;/strong&gt;.&lt;/li&gt;&lt;li&gt;2 new Public IP addresses for the Virtual Network Gateways: &lt;strong&gt;&lt;strong&gt;vpn-ip-a&lt;/strong&gt;&lt;/strong&gt; and &lt;strong&gt;&lt;strong&gt;vpn-ip-b&lt;/strong&gt;&lt;/strong&gt;.&lt;/li&gt;&lt;li&gt;2 new Local Network Gateways: &lt;strong&gt;&lt;strong&gt;local-gateway-a&lt;/strong&gt;&lt;/strong&gt; and &lt;strong&gt;&lt;strong&gt;local-gateway-b&lt;/strong&gt;&lt;/strong&gt;.&lt;/li&gt;&lt;li&gt;2 new Connections: &lt;strong&gt;&lt;strong&gt;vpn-connection-a&lt;/strong&gt;&lt;/strong&gt; and &lt;strong&gt;&lt;strong&gt;vpn-connection-b&lt;/strong&gt;&lt;/strong&gt;.&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;In the example I will be also considering that you have 2 different subscriptions, resource groups and locations.&lt;/p&gt;&lt;blockquote&gt;If you have your virtual networks under the same subscription, resource group or location it’s okay, just consider that the following are the same in your case.&lt;/blockquote&gt;&lt;ul&gt;&lt;li&gt;2 Subscriptions: &lt;strong&gt;&lt;strong&gt;subscription-a&lt;/strong&gt;&lt;/strong&gt; and &lt;strong&gt;&lt;strong&gt;subscription-b&lt;/strong&gt;&lt;/strong&gt; (can be the same).&lt;/li&gt;&lt;li&gt;2 Resource Groups: &lt;strong&gt;&lt;strong&gt;resource-group-a&lt;/strong&gt;&lt;/strong&gt; and &lt;strong&gt;&lt;strong&gt;resource-group-b&lt;/strong&gt;&lt;/strong&gt; (can be the same).&lt;/li&gt;&lt;li&gt;2 Locations: &lt;strong&gt;&lt;strong&gt;location-a&lt;/strong&gt;&lt;/strong&gt; and &lt;strong&gt;&lt;strong&gt;location-b&lt;/strong&gt;&lt;/strong&gt; (can be the same).&lt;/li&gt;&lt;/ul&gt;&lt;h4 id="network-specs"&gt;Network Specs&lt;/h4&gt;&lt;p&gt;These are the specs of the two networks. Notice that the IP address spaces are different, so they don’t collide. If they do now, you will have to change the address space in one of them before you continue.&lt;/p&gt;&lt;pre&gt;&lt;code&gt;network-a
  Address space: 10.0.0.0/16
  Subnets:
    subnet-a: 10.0.0.0/24
network-b
  Address space: 10.1.0.0/16
  Subnets:
    subnet-b: 10.1.0.0/24
&lt;/code&gt;&lt;/pre&gt;
&lt;h3 id="1-create-the-gateway-subnets"&gt;1. Create the Gateway Subnets&lt;/h3&gt;&lt;p&gt;The Virtual Network Gateways that we will create in the next step need that the networks have a special subnet inside exactly named &lt;strong&gt;&lt;strong&gt;GatewaySubnet&lt;/strong&gt;&lt;/strong&gt;. If you already have them just skip this step.&lt;/p&gt;&lt;p&gt;Go to &lt;em&gt;Virtual networks &amp;gt; Settings &amp;gt; Subnets&lt;/em&gt; and click the add Gateway subnet button. Choose an address space inside &lt;strong&gt;&lt;strong&gt;network-a&lt;/strong&gt;&lt;/strong&gt; that is bigger or equal to /29 and that doesn’t collide with the other subnets. For simplicity, I’m using /24. Repeat the steps with &lt;strong&gt;&lt;strong&gt;network-b&lt;/strong&gt;&lt;/strong&gt; so you end up with something like this:&lt;/p&gt;&lt;pre&gt;&lt;code&gt;network-a
  Address space: 10.0.0.0/16
  Subnets:
    subnet-a: 10.0.0.0/24
    GatewaySubnet: 10.0.1.0/24
network-b
  Address space: 10.1.0.0/16
  Subnets:
    subnet-b: 10.1.0.0/24
    GatewaySubnet: 10.1.1.0/24
&lt;/code&gt;&lt;/pre&gt;
&lt;h3 id="2-create-the-virtual-network-gateways"&gt;2. Create the Virtual Network Gateways&lt;/h3&gt;&lt;p&gt;Go to &lt;em&gt;Virtual network gateways &amp;gt; Add&lt;/em&gt; and select the following:&lt;/p&gt;&lt;pre&gt;&lt;code&gt;Name: vpn-gateway-a
Virtual network: network-a
Public IP address: vpn-ip-a (new)
Gateway type: VPN
VPN type: Route-based
Subscription: subscription-a
Resource group: resource-group-a
Location: location-a
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Repeat the steps for the other subscription/network:&lt;/p&gt;&lt;pre&gt;&lt;code&gt;Name: vpn-gateway-b
Virtual network: network-b
Public IP address: vpn-ip-b (new)
Gateway type: VPN
VPN type: Route-based
Subscription: subscription-b
Resource group: resource-group-b
Location: location-b
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The deploy can take up to 45 minutes, but we can set some other things up meanwhile.&lt;/p&gt;&lt;h3 id="3-find-the-ip-addresses"&gt;3. Find the IP addresses&lt;/h3&gt;&lt;p&gt;When the deploy of the previous step starts, you will have 2 new public IP addresses, &lt;strong&gt;&lt;strong&gt;vpn-ip-a&lt;/strong&gt;&lt;/strong&gt; and &lt;strong&gt;&lt;strong&gt;vpn-ip-b&lt;/strong&gt;&lt;/strong&gt;. It’s okay if the Virtual Network gateways are still deploying because the IPs are created at the beginning. If there aren’t there just wait a couple of minutes and refresh the list.&lt;/p&gt;&lt;p&gt;Go to &lt;em&gt;Public IP addresses, &lt;/em&gt;select &lt;strong&gt;&lt;strong&gt;vpn-ip-a&lt;/strong&gt;&lt;/strong&gt; and write down its number because we will need it later on. Do the same for &lt;strong&gt;&lt;strong&gt;vpn-ip-b&lt;/strong&gt;&lt;/strong&gt;. Let’s say these are my public IPs (yours will be different):&lt;/p&gt;&lt;pre&gt;&lt;code&gt;vpn-ip-a: 40.84.0.1
vpn-ip-b: 40.84.0.2
&lt;/code&gt;&lt;/pre&gt;
&lt;h3 id="4-create-the-local-network-gateways"&gt;4. Create the Local Network Gateways&lt;/h3&gt;&lt;p&gt;This is the tricky part that took me a couple of hours to figure out. In each side of the VPN, we have a virtual network with a virtual gateway (probably still deploying) that acts as a door to the outside Internet that sends and receives traffic to the other end. But we need something to tell our virtual network “hey, for these local IP address outside your address space, you will have to get them through the door at 40.84.0.X”.&lt;/p&gt;&lt;p&gt;So &lt;strong&gt;&lt;strong&gt;network-a&lt;/strong&gt;&lt;/strong&gt; needs to know that the 10.1.0.0/16 range, that is outside its address space (10.0.0.0/16), is reachable through &lt;strong&gt;&lt;strong&gt;vpn-ip-b&lt;/strong&gt;&lt;/strong&gt; (40.84.0.2). And &lt;strong&gt;&lt;strong&gt;network-b&lt;/strong&gt;&lt;/strong&gt; (10.1.0.0/16) needs to know that the outside space 10.0.0.0/16 is reachable through &lt;strong&gt;&lt;strong&gt;vpn-ip-a&lt;/strong&gt;&lt;/strong&gt; (40.84.0.1). This something is a &lt;strong&gt;&lt;strong&gt;Local Network Gateway&lt;/strong&gt;&lt;/strong&gt;.&lt;/p&gt;&lt;p&gt;Go to &lt;em&gt;Local network gateways &amp;gt; Add&lt;/em&gt; and create one for &lt;strong&gt;&lt;strong&gt;network-a&lt;/strong&gt;&lt;/strong&gt;:&lt;/p&gt;&lt;pre&gt;&lt;code&gt;Name: local-gateway-b
IP address: 40.84.0.2 (vpn-ip-b)
Address space: 10.1.0.0/16
Subscription: subscription-a
Resource group: resource-group-a
Location: location-a
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;See what happened here? We created the &lt;strong&gt;&lt;strong&gt;local-gateway-b&lt;/strong&gt;&lt;/strong&gt; in the same subscription and resource group as &lt;strong&gt;&lt;strong&gt;network-a&lt;/strong&gt;&lt;/strong&gt;, with the public IP and address space of &lt;strong&gt;&lt;strong&gt;network-b&lt;/strong&gt;&lt;/strong&gt;. This is how &lt;strong&gt;&lt;strong&gt;network-a&lt;/strong&gt;&lt;/strong&gt; knows how to get to an IP from &lt;strong&gt;&lt;strong&gt;network-b&lt;/strong&gt;&lt;/strong&gt;.&lt;/p&gt;&lt;p&gt;Let’s now create the one for &lt;strong&gt;&lt;strong&gt;network-b&lt;/strong&gt;&lt;/strong&gt;:&lt;/p&gt;&lt;pre&gt;&lt;code&gt;Name: local-gateway-a
IP address: 40.84.0.1 (vpn-ip-a)
Address space: 10.0.0.0/16
Subscription: subscription-b
Resource group: resource-group-b
Location: location-b
&lt;/code&gt;&lt;/pre&gt;
&lt;h3 id="5-create-the-connections"&gt;5. Create the Connections&lt;/h3&gt;&lt;blockquote&gt;From this point forward you need both Virtual Network Gateways to have finished deploying. If they haven’t, just chill out &lt;a href="https://savelist.co/?utm_source=engineering_blog" rel="noopener"&gt;or have a look at what we do at Savelist&lt;/a&gt;.&lt;/blockquote&gt;&lt;p&gt;With the Virtual Network Gateways deployed, we now need to create a connection between &lt;strong&gt;&lt;strong&gt;local-gateway-b&lt;/strong&gt;&lt;/strong&gt; and &lt;strong&gt;&lt;strong&gt;vpn-gateway-a&lt;/strong&gt;&lt;/strong&gt; (for &lt;em&gt;network-a&lt;/em&gt;) and another between &lt;strong&gt;&lt;strong&gt;local-gateway-a&lt;/strong&gt;&lt;/strong&gt; and &lt;strong&gt;&lt;strong&gt;vpn-gateway-b&lt;/strong&gt;&lt;/strong&gt; (for &lt;em&gt;network-b&lt;/em&gt;). This will complete the traffic routing.&lt;/p&gt;&lt;pre&gt;&lt;code&gt;   network-a
local-gateway-b
 vpn-gateway-a
      ||
   Internet
      ||
 vpn-network-b
local-gateway-a
  network-b
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Go to &lt;em&gt;Local network gateways&lt;/em&gt; in &lt;strong&gt;&lt;strong&gt;subscription-a&lt;/strong&gt;&lt;/strong&gt; and select &lt;strong&gt;&lt;strong&gt;local-gateway-b&lt;/strong&gt;&lt;/strong&gt;and then&lt;strong&gt;&lt;strong&gt; &lt;/strong&gt;&lt;/strong&gt;&lt;em&gt;Settings &amp;gt; Connections &amp;gt; Add&lt;/em&gt;. The &lt;em&gt;Connection type&lt;/em&gt; will already have &lt;em&gt;Site-to-site (IPsec)&lt;/em&gt; selected and greyed out.&lt;/p&gt;&lt;p&gt;You can choose any mix of letters and numbers as your shared key (PSK), as long as you put the same in both &lt;strong&gt;&lt;strong&gt;vpn-connection-a&lt;/strong&gt;&lt;/strong&gt; and &lt;strong&gt;&lt;strong&gt;vpn-connection-b&lt;/strong&gt;&lt;/strong&gt;. It acts as a password to secure the connection.&lt;/p&gt;&lt;blockquote&gt;Pro tip: &lt;a href="https://www.grc.com/passwords.htm" rel="noopener"&gt;The GRC site generates ultra secure passwords just for you through HTTPS&lt;/a&gt;. I copied and pasted the one in the 3rd box.&lt;/blockquote&gt;&lt;pre&gt;&lt;code&gt;Name: vpn-connection-b
Connection type: Site-to-site (IPsec)
Virtual network gateway: vpn-gateway-a
Local network gateway: local-gateway-b (locked)
Shared key (PSK): (choose a mix of letters and numbers)
Subscription: subscription-a
Location: location-a
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Repeat the process for &lt;strong&gt;&lt;strong&gt;local-gateway-a&lt;/strong&gt;&lt;/strong&gt; in &lt;strong&gt;&lt;strong&gt;subscription-b&lt;/strong&gt;&lt;/strong&gt;:&lt;/p&gt;&lt;pre&gt;&lt;code&gt;Name: vpn-connection-a
Connection type: Site-to-site (IPsec)
Virtual network gateway: vpn-gateway-b
Local network gateway: local-gateway-a (locked)
Shared key (PSK): (paste the same key as before)
Subscription: subscription-b
Location: location-b
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;If everything went well, after a few minutes the Virtual Networks Gateways will establish a connection and show with the &lt;em&gt;Connected&lt;/em&gt; status. If it doesn’t work after 10 minutes, check that the IPs and address spaces in the Local Network Gateways are correct and from the &lt;strong&gt;&lt;strong&gt;other&lt;/strong&gt;&lt;/strong&gt; network.&lt;/p&gt;&lt;h3 id="6-test-the-connection"&gt;6. Test the Connection&lt;/h3&gt;&lt;p&gt;You can just now log into a machine in &lt;strong&gt;&lt;strong&gt;network-a&lt;/strong&gt;&lt;/strong&gt; and try to access a machine in &lt;strong&gt;&lt;strong&gt;network-b&lt;/strong&gt;&lt;/strong&gt;, and viceversa. You will see the traffic increase in the connection details. If it doesn’t work, check the network security groups used by your virtual machines and/or virtual networks. If the VPN connection shows &lt;em&gt;Connected&lt;/em&gt;, then is working fine and something else in your networks is blocking the communication.&lt;/p&gt;&lt;hr&gt;&lt;blockquote&gt;Special thanks to &lt;a href="https://twitter.com/DevStarlight" rel="noopener"&gt;Jesús Huerta&lt;/a&gt;, who helped me translate the old and confusing articles from Microsoft to the newer Azure Portal and ARM.&lt;/blockquote&gt;</content:encoded></item></channel></rss></html>